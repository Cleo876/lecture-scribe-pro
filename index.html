<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Scribe Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-elevated: #2d3748;
            --input-bg: #020617;
            --border: #334155;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-glow: rgba(59, 130, 246, 0.3);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
            --accent: #8b5cf6;
            --scribe: #f59e0b;
            --card-front: #1e293b;
            --card-back: #0f172a;
            --gradient-1: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-2: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            --radius-lg: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "SF Pro Display", "Helvetica Neue", sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Background animation */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            opacity: 0.1;
        }

        .bg-particle {
            position: absolute;
            border-radius: 50%;
            background: var(--primary);
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-100px) translateX(100px); }
            50% { transform: translateY(-50px) translateX(-100px); }
            75% { transform: translateY(100px) translateX(50px); }
            100% { transform: translateY(0) translateX(0); }
        }

        /* --- LOGIN STYLES --- */
        #login-view {
            width: 100%;
            max-width: 420px;
            background: var(--surface);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 10;
            margin: 2rem auto;
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-logo {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .login-tagline {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 2rem;
            position: relative;
            display: inline-block;
        }

        .login-tagline::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background: var(--gradient-1);
            border-radius: 2px;
        }

        /* --- MAIN CONTAINER STYLES --- */
        .container {
            width: 100%;
            max-width: 700px;
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            margin: 0 auto;
            backdrop-filter: blur(10px);
        }
        
        .container.wide-mode {
            max-width: 1200px;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        /* Fixed header with proper spacing */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 0 0 1rem 0;
            border-bottom: 1px solid var(--border);
            position: relative;
            min-height: 60px;
            flex-wrap: wrap;
        }

        /* Left section of header */
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 0;
        }

        /* History button in header - FIXED POSITION */
        .header-history-btn {
            position: relative;
            margin-right: 10px;
            flex-shrink: 0;
        }

        /* Title and badge */
        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
            flex: 1;
        }

        h1 { 
            margin: 0; 
            font-size: 1.8rem; 
            font-weight: 800; 
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-badge {
            background: var(--gradient-1);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Right section of header */
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            margin-left: 10px;
        }

        p.subtitle { 
            text-align: center; 
            color: var(--text-muted); 
            margin-bottom: 2rem; 
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Control Buttons */
        .control-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
        }

        /* Fullscreen button in container */
        .fullscreen-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }

        /* History Sidebar */
        .history-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: var(--surface);
            border-left: 1px solid var(--border);
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
        }

        .history-sidebar.active {
            right: 0;
        }

        .history-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-header h3 {
            font-size: 1.3rem;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .history-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .session-item {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .session-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .session-item:hover {
            transform: translateX(-5px);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.1);
        }

        .session-item:hover::before {
            opacity: 1;
        }

        .session-item.active {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .session-item.active::before {
            opacity: 1;
        }

        .session-course {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-date {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .session-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .session-item:hover .session-actions {
            opacity: 1;
        }

        .session-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .session-action-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .empty-history {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        .empty-history i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Mode Tabs */
        .mode-tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 1.5rem; 
            background: var(--input-bg);
            padding: 5px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }
        
        .mode-btn { 
            flex: 1; 
            background: transparent; 
            border: none; 
            color: var(--text-muted); 
            padding: 10px 15px; 
            cursor: pointer; 
            border-radius: var(--radius-sm);
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
            white-space: normal;
            word-break: break-word;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            text-align: center;
        }
        
        .mode-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--gradient-1);
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .mode-btn.active { 
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary); 
        }
        
        .mode-btn.active::after {
            width: 80%;
        }

        /* Input Groups */
        .input-group { 
            margin-bottom: 1.5rem; 
            position: relative;
        }
        
        .label-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 0.8rem; 
        }
        
        label { 
            display: block; 
            font-size: 0.85rem; 
            font-weight: 600; 
            color: var(--text-main); 
            margin: 0; 
        }
        
        .api-help-link {
            font-size: 0.8rem; 
            color: var(--primary); 
            text-decoration: none; 
            cursor: pointer; 
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .api-help-link:hover { 
            color: var(--primary-hover); 
            text-decoration: underline; 
        }

        /* Form Controls */
        .form-control {
            width: 100%; 
            padding: 0.9rem 1rem; 
            background: var(--input-bg); 
            border: 1px solid var(--border);
            border-radius: var(--radius-md); 
            color: var(--text-main); 
            font-size: 0.95rem; 
            box-sizing: border-box;
            transition: var(--transition); 
            font-family: inherit;
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        /* Cards */
        .card {
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.2rem;
            margin-bottom: 1.2rem;
            transition: var(--transition);
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Buttons */
        .btn {
            padding: 0.9rem 1.2rem; 
            border: none; 
            border-radius: var(--radius-md); 
            font-size: 0.95rem; 
            font-weight: 600; 
            cursor: pointer;
            transition: var(--transition); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            position: relative;
            overflow: hidden;
            white-space: normal;
            word-break: break-word;
            text-align: center;
            min-height: 44px;
            flex-wrap: wrap;
            text-decoration: none; /* For download links */
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none !important;
        }
        
        .btn-primary { 
            background: var(--gradient-1); 
            color: white; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            color: var(--text-muted); 
        }
        
        .btn-secondary:hover:not(:disabled) { 
            background: var(--surface-elevated); 
            color: var(--text-main);
            border-color: var(--primary);
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }
        
        .btn-warning { 
            background: var(--scribe); 
            color: #000; 
        }
        
        .btn-accent { 
            background: var(--accent); 
            color: white; 
        }
        
        .btn-success { 
            background: var(--success); 
            color: #000; 
        }

        /* --- DOWNLOAD BUTTON STYLE --- */
        .btn-app-dl {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-app-dl:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-sm {
            padding: 0.5rem 0.8rem;
            font-size: 0.85rem;
            width: auto;
            min-height: 36px;
        }

        /* Recording UI */
        .recording-ui {
            background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .recording-ui::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
            animation: recordingLine 2s infinite linear;
        }

        @keyframes recordingLine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .timer { 
            font-family: 'SF Mono', 'Courier New', monospace; 
            font-size: 2.8rem; 
            color: var(--success); 
            font-weight: 800; 
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }
        
        .status-badge {
            display: inline-block; 
            padding: 6px 16px; 
            border-radius: 50px; 
            font-size: 0.8rem; 
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger); 
            border: 1px solid rgba(239, 68, 68, 0.3);
            font-weight: 600;
            letter-spacing: 0.5px;
            animation: pulse 2s infinite;
            margin-bottom: 1rem;
        }

        /* Result Tabs - FIXED to prevent overflow */
        .result-tabs { 
            display: flex; 
            gap: 4px; 
            background: var(--input-bg); 
            padding: 4px; 
            border-radius: var(--radius-md); 
            margin-bottom: 1rem; 
            border: 1px solid var(--border); 
            overflow: hidden;
        }
        
        .result-tab-btn {
            flex: 1; 
            padding: 10px 12px; 
            background: transparent; 
            border: none; 
            color: var(--text-muted); 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            transition: var(--transition); 
            position: relative;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.85rem;
            min-width: 0;
            overflow: hidden;
            white-space: normal;
            word-break: break-word;
            text-align: center;
            min-height: 44px;
            flex-wrap: wrap;
        }
        
        .result-tab-btn.active { 
            background: var(--surface); 
            color: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
        }
        
        .result-tab-btn.active.study-tab { 
            color: var(--primary); 
        }
        
        .result-tab-btn.active.scribe-tab { 
            color: var(--scribe); 
        }
        
        .result-tab-btn.active.cards-tab { 
            color: var(--success); 
        }

        .result-tab-btn .badge {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
            flex-shrink: 0;
        }

        .result-tab-btn.active .badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Output Panes - FIXED layout */
        .output-pane { 
            display: none; 
            flex-direction: column; 
            flex-grow: 1; 
            height: 100%; 
            min-height: 400px;
        }
        
        .output-pane.active { 
            display: flex; 
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-box {
            width: 100%; 
            flex-grow: 1; 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            border-radius: var(--radius-md);
            color: var(--text-main); 
            padding: 1.5rem; 
            font-family: 'Inter', 'Georgia', serif; 
            line-height: 1.6;
            font-size: 1rem; 
            overflow-y: auto; 
            box-sizing: border-box;
            min-height: 300px;
        }

        .result-box h1, .result-box h2, .result-box h3 { 
            color: #ffffff; 
            margin-top: 1.2em; 
            margin-bottom: 0.5em; 
            border-bottom: 1px solid #334155; 
            padding-bottom: 5px; 
        }

        /* Math symbol styling */
        .math-symbol {
            font-family: "Cambria Math", "Symbol", "STIXGeneral", serif;
            font-style: normal;
            display: inline-block;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background: var(--input-bg);
            border-radius: 10px;
            height: 6px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Flashcard Enhancements - FIXED to stay within bounds */
        .flashcard-container {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            border-radius: var(--radius-md); 
            padding: 1.5rem;
            position: relative;
            min-height: 350px;
            width: 100%;
            overflow: hidden;
        }
        
        .flashcard { 
            width: 100%; 
            max-width: 500px; 
            height: 300px; 
            perspective: 1000px; 
            cursor: pointer; 
            margin: 0 auto;
        }
        
        .flashcard-inner { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            text-align: center; 
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform-style: preserve-3d; 
        }
        
        .flashcard.flipped .flashcard-inner { 
            transform: rotateY(180deg); 
        }
        
        .flashcard-front, .flashcard-back {
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1.5rem; 
            box-sizing: border-box;
            border-radius: var(--radius-md); 
            border: 1px solid var(--border); 
            font-size: 1.2rem; 
            line-height: 1.5;
            box-shadow: var(--shadow-md);
            overflow: auto;
            word-wrap: break-word;
        }
        
        .flashcard-front { 
            background: var(--surface); 
            color: var(--text-main); 
        }
        
        .flashcard-back { 
            background: var(--bg); 
            color: var(--accent); 
            transform: rotateY(180deg); 
            border-color: var(--accent); 
        }

        .card-progress {
            width: 100%;
            max-width: 500px;
            margin-top: 1rem;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .progress-track {
            height: 5px;
            background: var(--input-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Alerts */
        .alert {
            padding: 0.9rem 1.2rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
            color: #fca5a5;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--scribe);
            color: #fcd34d;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            border-color: var(--success);
            color: #86efac;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary);
            color: #93c5fd;
        }

        .alert-icon {
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        /* Modals */
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 3000; 
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 2rem; 
            border-radius: var(--radius-lg);
            max-width: 500px; 
            width: 90%; 
            color: var(--text-main); 
            box-shadow: var(--shadow-lg);
            animation: modalSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, 
                var(--input-bg) 25%, 
                var(--surface) 50%, 
                var(--input-bg) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                display: block;
            }
            
            .container {
                padding: 1.2rem;
                margin: 0;
                max-width: 100%;
            }
            
            .history-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .timer {
                font-size: 2.2rem;
            }
            
            .control-buttons {
                gap: 5px;
            }
            
            .icon-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .header-badge {
                font-size: 0.6rem;
                padding: 3px 8px;
            }
            
            .result-tab-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
                min-height: 40px;
            }
            
            .flashcard {
                height: 250px;
            }
            
            .flashcard-front, .flashcard-back {
                font-size: 1rem;
                padding: 1rem;
            }
            
            .mode-btn, .btn {
                font-size: 0.85rem;
                padding: 0.8rem 1rem;
            }
        }

        /* CUSTOM UTILITY CLASS: hides element on medium (â‰¥768px) and larger screens */
        @media (min-width: 768px) {
            .md\:hidden {
                display: none !important;
            }
        }

        @media (max-width: 480px) {
            .app-header {
                flex-wrap: wrap;
                gap: 10px;
                min-height: auto;
            }
            
            .header-left, .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .header-title {
                justify-content: center;
                width: 100%;
                margin: 5px 0;
            }
            
            .mode-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
                min-height: 40px;
            }
            
            .btn {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
            
            #login-view {
                padding: 1.5rem;
                margin: 1rem auto;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--input-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            transform: translateX(150%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-success {
            border-left: 4px solid var(--success);
        }
        
        .toast-error {
            border-left: 4px solid var(--danger);
        }
        
        .toast-warning {
            border-left: 4px solid var(--scribe);
        }
        
        .toast-info {
            border-left: 4px solid var(--primary);
        }
        
        .toast i {
            font-size: 1.1rem;
        }
        
        .toast-success i { color: var(--success); }
        .toast-error i { color: var(--danger); }
        .toast-warning i { color: var(--scribe); }
        .toast-info i { color: var(--primary); }
        
        /* Tab spinner */
        .tab-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 5px;
        }
        
        /* Audio player */
        .audio-player-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            display: flex;
            gap: 8px;
            align-items: center;
            border: 1px solid var(--border);
        }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation" id="bgAnimation"></div>

    <!-- NETWORK LOGIN VIEW -->
    <div id="login-view">
        <div class="login-logo">Lecture Scribe Pro</div>
        <div class="login-tagline">Intelligent Academic Assistant</div>
        
        <div class="input-group">
            <label><i class="fas fa-envelope"></i> User Email</label>
            <input type="text" id="login-email" class="form-control" placeholder="student@university.edu">
        </div>
        
        <div class="input-group">
            <label><i class="fas fa-key"></i> Verification U-CODE</label>
            <input type="text" id="login-ucode" class="form-control" placeholder="XXXX" maxlength="16" 
                   style="text-align: center; font-family: monospace; letter-spacing: 0.3em; text-transform: uppercase;">
        </div>
        
        <button id="btn-login" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i> Verify Access
        </button>
        <div id="login-status" style="margin-top: 1.2rem; font-size: 0.85rem; min-height: 1.2rem; text-align: center;"></div>
    </div>

    <!-- History Sidebar -->
    <div class="history-sidebar" id="historySidebar">
        <div class="history-header">
            <h3><i class="fas fa-history"></i> Session History</h3>
            <button class="icon-btn" id="btnCloseHistory">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="history-content">
            <div class="session-list" id="sessionList">
                <!-- Session items will be populated here -->
            </div>
            <div class="empty-history hidden" id="emptyHistory">
                <i class="fas fa-clock"></i>
                <p>No past sessions found</p>
                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Your processed lectures will appear here</p>
            </div>
        </div>
        <div style="padding: 1.2rem; border-top: 1px solid var(--border);">
            <button class="btn btn-secondary" id="btnClearHistory" style="width: 100%;">
                <i class="fas fa-trash"></i> Clear All History
            </button>
        </div>
    </div>

    <!-- API Key Help Modal -->
    <div id="helpModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-title" style="font-size: 1.3rem; margin-bottom: 1rem; color: var(--primary);">
                <i class="fas fa-key"></i> Get Your Free API Key
            </div>
            <ol class="step-list" style="margin: 1.2rem 0; padding-left: 1.5rem; line-height: 1.6; font-size: 0.9rem;">
                <li><strong>Sign In:</strong> Log in to your Google account</li>
                <li><strong>Create Key:</strong> Click the blue "Create API key" button</li>
                <li><strong>Select Project:</strong> Choose "Create new project"</li>
                <li><strong>Copy Key:</strong> Click the <i class="fas fa-copy"></i> copy icon</li>
                <li><strong>Paste Here:</strong> Return and paste in the API Key field</li>
            </ol>
            <div style="background: rgba(59, 130, 246, 0.1); padding: 0.9rem; border-radius: var(--radius-md); margin: 1.2rem 0;">
                <p style="margin: 0; font-size: 0.85rem; color: #93c5fd;">
                    <i class="fas fa-info-circle"></i> Free tier provides ~500 requests/day. Perfect for student use!
                </p>
            </div>
            <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end;">
                <button id="btnCloseModal" class="btn btn-secondary btn-sm">
                    Close
                </button>
                <a href="https://aistudio.google.com/api-keys" target="_blank" style="text-decoration: none;">
                    <button class="btn btn-primary btn-sm">
                        <i class="fas fa-external-link-alt"></i> Get API Key
                    </button>
                </a>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="mainContainer" class="container hidden">
        <!-- Fullscreen button -->
        <button id="btnFullscreen" class="icon-btn fullscreen-btn" title="Toggle Fullscreen">
            <i class="fas fa-expand"></i>
        </button>

        <!-- App Header with proper spacing -->
        <div class="app-header">
            <div class="header-left">
                <button id="btnOpenHistory" class="icon-btn header-history-btn" title="Session History">
                    <i class="fas fa-history"></i>
                </button>
                <div class="header-title">
                    <h1>Lecture Scribe Pro</h1>
                    <span class="header-badge">v2.1.0</span>
                </div>
            </div>
            
            <div class="header-right">
                <!-- DOWNLOAD BUTTON (Hidden by default, shown via JS if not in App) -->
                <!-- REPLACE THE HREF WITH YOUR ACTUAL APK LINK -->
                <a href="https://raw.githubusercontent.com/Cleo876/lecture-scribe-pro/refs/heads/main/app/lecture-scribe-pro.apk" id="btnDownloadApp" class="btn btn-app-dl btn-sm hidden md:hidden" download>
                    <i class="fab fa-android"></i> Get App
                </a>

                <button id="btnWatchTutorial" class="btn btn-primary btn-sm">
                    <i class="fas fa-play-circle"></i> Tutorial
                </button>
            </div>
        </div>

        <p class="subtitle">
            <i class="fas fa-brain"></i> Triple-Engine AI: Study Guide â€¢ Transcription â€¢ Interactive Flashcards
        </p>

        <!-- Alerts -->
        <div id="quotaAlert" class="alert alert-danger hidden">
            <i class="fas fa-exclamation-triangle alert-icon"></i>
            <div>
                <strong>API Limit Warning</strong>
                <p style="margin-top: 5px; font-size: 0.85rem;">You've reached the rate limit. Please wait a minute before trying again.</p>
            </div>
        </div>

        <div id="protocolAlert" class="alert alert-warning hidden">
            <i class="fas fa-mobile-alt alert-icon"></i>
            <div>
                <strong>Mobile Permission Required</strong>
                <p style="margin-top: 5px; font-size: 0.85rem;">Upload this file to a secure website (HTTPS) for microphone access.</p>
            </div>
        </div>

        <!-- Main Content -->
        <div id="step-setup">
            <!-- Direct Review Mode -->
            <div class="card review-mode-container">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <i class="fas fa-folder-open" style="color: var(--success); font-size: 1.1rem;"></i>
                    <h3 style="margin: 0; font-size: 1.1rem; color: var(--success);">Load Previous Session</h3>
                </div>
                <p style="margin-bottom: 12px; color: var(--text-muted); font-size: 0.9rem;">
                    Review your past lectures or import flashcards from previous sessions.
                </p>
                <div style="display: flex; gap: 8px;">
                    <input type="file" id="directReviewInput" accept=".csv" class="hidden">
                    <button id="btnDirectReview" class="btn btn-secondary" style="flex: 1;">
                        <i class="fas fa-file-import"></i> Import Flashcards
                    </button>
                    <button id="btnLoadSession" class="btn btn-success" style="flex: 1;">
                        <i class="fas fa-history"></i> Load Session
                    </button>
                </div>
            </div>

            <div style="text-align: center; margin: 1.5rem 0; position: relative;">
                <div style="height: 1px; background: var(--border);"></div>
                <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); 
                           background: var(--surface); padding: 0 0.8rem; color: var(--text-muted); font-size: 0.8rem;">
                    OR CREATE NEW SESSION
                </span>
            </div>

            <!-- API Configuration -->
            <div class="card">
                <div class="input-group">
                    <div class="label-row">
                        <label for="apiKey"><i class="fas fa-key"></i> Gemini API Key</label>
                        <a id="btnOpenHelp" class="api-help-link">
                            <i class="fas fa-question-circle"></i> Need a key?
                        </a>
                    </div>
                    <input type="password" id="apiKey" class="form-control" 
                           placeholder="Paste your AI Studio Key here (Auto-saves)">
                    <span id="modelLoadStatus" style="font-size: 0.8rem; margin-top: 6px; display: block; height: 1.2rem;"></span>
                </div>
                
                <div class="input-group">
                    <label for="modelSelect"><i class="fas fa-robot"></i> AI Model</label>
                    <select id="modelSelect" class="form-control">
                        <option value="gemini-1.5-flash">ðŸš€ Gemini 1.5 Flash (Fast & Free)</option>
                        <option value="gemini-1.5-pro">ðŸ§  Gemini 1.5 Pro (Advanced)</option>
                    </select>
                    <div class="model-info" style="margin-top: 8px; padding: 8px; background: rgba(59, 130, 246, 0.05); 
                                                border-radius: var(--radius-sm); border: 1px solid rgba(59, 130, 246, 0.2); font-size: 0.8rem;">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                            <i class="fas fa-chart-line" style="color: var(--primary); font-size: 0.9rem;"></i>
                            <span style="font-weight: 600; color: var(--primary);">Free Tier Limits:</span>
                        </div>
                        <div style="line-height: 1.4; color: var(--text-muted);">
                            â€¢ Flash: ~500 recordings/day<br>
                            â€¢ Pro: ~16 recordings/day<br>
                            â€¢ Speed limit: 1-5 recordings/minute
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recording Configuration -->
            <div class="card">
                <div class="input-group">
                    <div class="label-row">
                        <label for="micSelect"><i class="fas fa-microphone"></i> Microphone</label>
                        <a id="btnRefreshMics" class="api-help-link">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </a>
                    </div>
                    <select id="micSelect" class="form-control">
                        <option value="">Default System Microphone</option>
                    </select>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px;">
                        <i class="fas fa-info-circle"></i> Click "Refresh" to grant permissions and see all devices
                    </p>
                </div>

                <div class="input-group">
                    <label for="micQuality"><i class="fas fa-volume-up"></i> Recording Quality</label>
                    <select id="micQuality" class="form-control">
                        <option value="32000">ðŸŽµ Standard (32 kbps) - Best for lectures</option>
                        <option value="128000">ðŸŽ§ High Quality (128 kbps) - Clear audio</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="courseName"><i class="fas fa-graduation-cap"></i> Course / Class Name</label>
                    <input type="text" id="courseName" class="form-control" 
                           placeholder="e.g., Advanced Calculus II - Prof. Smith">
                </div>
            </div>

            <!-- Mode Tabs -->
            <div class="mode-tabs">
                <button id="tabRecord" class="mode-btn active">
                    <i class="fas fa-microphone"></i> Record Audio
                </button>
                <button id="tabUpload" class="mode-btn">
                    <i class="fas fa-upload"></i> Upload File
                </button>
            </div>

            <!-- Record Mode -->
            <div id="modeRecord">
                <button id="btnStart" class="btn btn-primary" style="font-size: 1rem; padding: 1rem;">
                    <i class="fas fa-circle"></i> Start Recording Session
                </button>
                <div style="text-align: center; margin-top: 1.2rem; color: var(--text-muted); font-size: 0.8rem;">
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <span><i class="fas fa-database"></i> IndexedDB Storage</span>
                        <span><i class="fas fa-lock"></i> Wake Lock</span>
                        <span><i class="fas fa-shield-alt"></i> 99.5MB Auto-Stop</span>
                    </div>
                </div>
            </div>

            <!-- Upload Mode -->
            <div id="modeUpload" class="hidden">
                <div class="card">
                    <div class="input-group">
                        <label style="margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-file-audio"></i> Select Audio File
                        </label>
                        <input type="file" id="fileUpload" accept="audio/*" class="hidden">
                        <button id="btnSelectFile" class="btn btn-secondary" style="width: 100%; padding: 0.9rem;">
                            <i class="fas fa-folder-open" style="font-size: 1.1rem;"></i>
                            <span>Choose Audio File</span>
                        </button>
                        <div id="fileNameDisplay" style="margin-top: 12px; text-align: center; padding: 8px; 
                                                        background: rgba(59, 130, 246, 0.05); border-radius: var(--radius-sm); font-size: 0.9rem;">
                            <i class="fas fa-music"></i> No file selected
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 4px;">
                                Supports: MP3, WAV, M4A, AAC, FLAC, OGG
                            </div>
                        </div>
                    </div>
                </div>
                <button id="btnUploadProcess" class="btn btn-primary" style="margin-top: 8px;">
                    <i class="fas fa-cogs"></i> Process Uploaded File
                </button>
            </div>

            <!-- AI Prompts -->
            <div style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 0.8rem; color: var(--text-main); display: flex; align-items: center; gap: 8px; font-size: 1.1rem;">
                    <i class="fas fa-sliders-h"></i> Customize AI Instructions
                </h3>
                
                <details class="advanced-settings" style="margin-bottom: 8px;">
                    <summary style="padding: 0.9rem; background: var(--surface-elevated); border-radius: var(--radius-md); 
                                  cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <i class="fas fa-book-open" style="color: var(--primary);"></i>
                        <span>Engine 1: Study Mode Prompt</span>
                    </summary>
                    <div class="prompt-editor" style="padding: 0.9rem; background: var(--input-bg); border-radius: var(--radius-md); margin-top: 4px;">
                        <textarea id="promptStudy" class="form-control prompt-box" rows="6" style="font-size: 0.85rem;">You are an expert academic peer who understands this topic deeply.
Course: "[COURSE_NAME]".

Goal: Don't just summarize. Explain the material with deep understanding and offer a unique perspective that might not be obvious from the lesson alone.
CRITICAL: DO NOT USE LATEX ($ delimiters). Use actual UNICODE symbols for math (e.g. use "A âˆª B" not "$A \cup B$", use "Î±, Î², Î³" not "$\alpha, \beta, \gamma$", use "âˆ‘" not "$\sum$", use "âˆ«" not "$\int$", use "âˆš" not "$\sqrt{}$").

Structure:
# 1. THE CLASS NAME
(Identify the specific subject).

# 2. WHAT WAS DISCUSSED
(A comprehensive summary of the topics).

# 3. SIMPLIFIED PERSPECTIVE & EXAMPLES
(Identify the hardest concept. Explain it in plain English. Provide a concrete analogy).

# 4. ASSIGNMENTS MENTIONED
(List specific homework. If none, state "No specific assignments detected").

# 5. DUE DATES & PORTALS
(List specific dates. If none, state "No due dates detected").</textarea>
                    </div>
                </details>

                <details class="advanced-settings" style="margin-bottom: 8px;">
                    <summary style="padding: 0.9rem; background: var(--surface-elevated); border-radius: var(--radius-md); 
                                  cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <i class="fas fa-pencil-alt" style="color: var(--scribe);"></i>
                        <span>Engine 2: Scribe Note-Taker Prompt</span>
                    </summary>
                    <div class="prompt-editor" style="padding: 0.9rem; background: var(--input-bg); border-radius: var(--radius-md); margin-top: 4px;">
                        <textarea id="promptScribe" class="form-control prompt-box" rows="6" style="font-size: 0.85rem;">You are an expert academic note-taker.
Course: "[COURSE_NAME]".

Goal: Create a natural, chronological set of lecture notes that captures the detailed flow of the class.
CRITICAL: DO NOT USE LATEX ($ delimiters). Use actual UNICODE symbols for math.

Structure:
1. **Executive Summary**: Start with a "WHAT WAS DISCUSSED" section (digestible bullet points).
2. **Detailed Lecture Notes**:
   - Use a hierarchical outline format (Headers > Bullets > Indented Sub-bullets).
   - Capture the speaker's narrative flow, specific analogies, and examples.
   - For definitions, quote the specific phrasing used by the speaker where possible.
   - Highlight key terms in **bold**.

Constraints:
- AVOID EXCESSIVE TABLES. Only use a table if there is a strict data comparison. Use standard lists for most comparisons.
- Do not summarize too heavily; preserve the detail and nuance of the explanation.
- Use headers (##) to denote topic shifts.</textarea>
                    </div>
                </details>

                <details class="advanced-settings">
                    <summary style="padding: 0.9rem; background: var(--surface-elevated); border-radius: var(--radius-md); 
                                  cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <i class="fas fa-layer-group" style="color: var(--success);"></i>
                        <span>Engine 3: Flashcard Generator Prompt</span>
                    </summary>
                    <div class="prompt-editor" style="padding: 0.9rem; background: var(--input-bg); border-radius: var(--radius-md); margin-top: 4px;">
                        <textarea id="promptCards" class="form-control prompt-box" rows="6" style="font-size: 0.85rem;">You are a Flashcard Generator.
Course: "[COURSE_NAME]".

Goal: Create 10-15 high-yield study flashcards for ACTIVE RECALL.
Output: JSON Array of objects. No other text.
Format:
[
  { "front": "Question? (e.g. Define X, What is Y?, How does Z work?)", "back": "Clear Answer or Definition" }
]
IMPORTANT: The 'front' MUST be a specific Question or a Term to define. Do not use random statements. The 'back' must be the direct answer.
CRITICAL: DO NOT USE LATEX ($ delimiters). Use actual UNICODE symbols for math (e.g. use "A âˆª B" not "$A \cup B$", use "Î±, Î², Î³" not "$\alpha, \beta, \gamma$", use "âˆ‘" not "$\sum$", use "âˆ«" not "$\int$").</textarea>
                    </div>
                </details>
            </div>
        </div>

        <!-- Recording View -->
        <div id="step-recording" class="hidden">
            <div class="recording-ui">
                <div id="recordingStatus" class="status-badge">
                    <i class="fas fa-circle"></i> RECORDING LIVE
                </div>
                <div id="timer" class="timer">00:00:00</div>
                <div id="sizeMonitor" style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 5px;">
                    <i class="fas fa-hdd"></i> Current Size: <span id="sizeValue">0.00</span> MB
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="sizeProgress"></div>
                </div>
                <p style="font-size: 0.8rem; color: var(--scribe); margin-top: 8px;">
                    <i class="fas fa-shield-alt"></i> Auto-submits at 99.5 MB
                </p>
            </div>
            <div class="recording-controls" style="display: flex; gap: 12px;">
                <button id="btnPause" class="btn btn-warning" style="flex: 1;">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button id="btnStop" class="btn btn-danger" style="flex: 1;">
                    <i class="fas fa-stop"></i> Stop & Process
                </button>
            </div>
        </div>

        <!-- Processing View -->
        <div id="step-processing" class="hidden">
            <div style="text-align: center; padding: 2rem 1rem;">
                <div class="loading-spinner" style="width: 50px; height: 50px; border-width: 4px; margin: 0 auto 1.5rem;"></div>
                <p id="processStatus" style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.8rem;">
                    Initializing AI Processing...
                </p>
                <div class="progress-container" style="max-width: 350px; margin: 1.5rem auto;">
                    <div class="progress-bar" id="processProgress"></div>
                </div>
                <p id="processSubStatus" style="font-size: 0.9rem; color: var(--text-muted); margin-top: 1.2rem;">
                    <i class="fas fa-sync fa-spin"></i> Processing audio with Gemini AI...
                </p>
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 1.5rem; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="width: 10px; height: 10px; background: var(--primary); border-radius: 50%; 
                                  margin: 0 auto 4px;"></div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Study Guide</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 10px; height: 10px; background: var(--scribe); border-radius: 50%; 
                                  margin: 0 auto 4px;"></div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Scribe Notes</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; 
                                  margin: 0 auto 4px;"></div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Flashcards</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="step-result" class="hidden">
            <div class="result-tabs">
                <button id="btnTabStudy" class="result-tab-btn study-tab active">
                    <i class="fas fa-book-open"></i> Study Mode
                    <span class="badge" id="studyBadge">Loading...</span>
                    <span id="spinStudy" class="tab-spinner hidden"></span>
                </button>
                <button id="btnTabScribe" class="result-tab-btn scribe-tab">
                    <i class="fas fa-pencil-alt"></i> Scribe Notes
                    <span class="badge" id="scribeBadge">Loading...</span>
                    <span id="spinScribe" class="tab-spinner hidden"></span>
                </button>
                <button id="btnTabCards" class="result-tab-btn cards-tab">
                    <i class="fas fa-layer-group"></i> Flashcards
                    <span class="badge" id="cardsBadge">0 cards</span>
                    <span id="spinCards" class="tab-spinner hidden"></span>
                </button>
            </div>

            <!-- Study Mode Pane -->
            <div id="paneStudy" class="output-pane active">
                <div class="audio-player-controls">
                    <button onclick="speakText('outputStudy')" class="btn btn-primary btn-sm" style="flex: 1;">
                        <i class="fas fa-headphones"></i> Listen to Notes
                    </button>
                    <button onclick="stopSpeech()" class="btn btn-danger btn-sm" style="width: auto;">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button onclick="saveSession()" class="btn btn-success btn-sm" style="width: auto;">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
                
                <div id="outputStudy" class="result-box"></div>
                <div style="display: flex; justify-content: space-between; margin-top: 15px; gap: 10px; flex-wrap: wrap;">
                    <button id="btnDlStudy" onclick="downloadRTF('study')" class="btn btn-accent" disabled>
                        <i class="fas fa-download"></i> Download Study Guide
                    </button>
                    <button onclick="location.reload()" class="btn btn-secondary btn-sm">
                        <i class="fas fa-plus"></i> New Session
                    </button>
                </div>
            </div>

            <!-- Scribe Mode Pane -->
            <div id="paneScribe" class="output-pane">
                <div class="audio-player-controls">
                    <button onclick="speakText('outputScribe')" class="btn btn-warning btn-sm" style="flex: 1;">
                        <i class="fas fa-headphones"></i> Listen to Notes
                    </button>
                    <button onclick="stopSpeech()" class="btn btn-danger btn-sm" style="width: auto;">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button onclick="saveSession()" class="btn btn-success btn-sm" style="width: auto;">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
                
                <div id="outputScribe" class="result-box"></div>
                <div style="display: flex; justify-content: space-between; margin-top: 15px; gap: 10px; flex-wrap: wrap;">
                    <button id="btnDlScribe" onclick="downloadRTF('scribe')" class="btn btn-warning" disabled>
                        <i class="fas fa-download"></i> Download Scribe Notes
                    </button>
                    <button onclick="location.reload()" class="btn btn-secondary btn-sm">
                        <i class="fas fa-plus"></i> New Session
                    </button>
                </div>
            </div>

            <!-- Flashcards Pane -->
            <div id="paneCards" class="output-pane">
                <div id="flashcardContainer" class="flashcard-container">
                    <div class="flashcard" id="activeCard">
                        <div class="flashcard-inner">
                            <div class="flashcard-front" id="cardFront">
                                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">
                                    <i class="fas fa-lightbulb"></i> Click to flip card
                                </div>
                                <div style="font-size: 1.5rem; font-weight: 600; line-height: 1.4; word-break: break-word;" id="cardFrontText">
                                    Loading flashcards...
                                </div>
                            </div>
                            <div class="flashcard-back" id="cardBack">
                                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">
                                    <i class="fas fa-check-circle"></i> Answer
                                </div>
                                <div style="font-size: 1.3rem; line-height: 1.4; word-break: break-word;" id="cardBackText"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-progress">
                        <div class="progress-text">
                            <span>Progress</span>
                            <span id="cardCounter">0 / 0</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" id="cardProgress"></div>
                        </div>
                    </div>
                    
                    <div class="card-controls" style="display: flex; gap: 15px; margin-top: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-sm" id="btnPrevCard" style="width: auto;">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button class="btn btn-primary btn-sm" id="btnFlipCard" style="width: auto;">
                            <i class="fas fa-sync-alt"></i> Flip Card
                        </button>
                        <button class="btn btn-secondary btn-sm" id="btnNextCard" style="width: auto;">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 20px; justify-content: space-between; flex-wrap: wrap;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <input type="file" id="importCardsInput" accept=".csv" class="hidden">
                        <button id="btnImportCards" class="btn btn-secondary btn-sm">
                            <i class="fas fa-file-import"></i> Import Deck
                        </button>
                        <button id="btnDlCards" onclick="downloadFlashcards()" class="btn btn-success btn-sm" disabled>
                            <i class="fas fa-download"></i> Export to Anki
                        </button>
                    </div>
                    <button onclick="location.reload()" class="btn btn-secondary btn-sm">
                        <i class="fas fa-plus"></i> New Session
                    </button>
                </div>
                <p style="text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 12px;">
                    <i class="fas fa-info-circle"></i> CSV compatible with Anki, Quizlet, and Brainscape
                </p>
            </div>
        </div>
    </div>

    <!-- Tutorial Video Modal -->
    <div id="tutorialModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.2rem;">
                <h2 style="margin: 0; color: var(--primary); font-size: 1.3rem;">
                    <i class="fas fa-graduation-cap"></i> Lecture Scribe Pro Tutorial
                </h2>
                <button id="btnCloseTutorial" class="icon-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="position: relative; width: 100%; padding-top: 56.25%; background: #000; border-radius: var(--radius-md); overflow: hidden;">
                <video id="tutorialVideo" controls style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    Your browser does not support the video tag.
                </video>
            </div>
            
            <div style="margin-top: 1.2rem; padding: 0.9rem; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-md);">
                <h4 style="margin-bottom: 8px; color: var(--text-main); font-size: 1rem;">
                    <i class="fas fa-tips"></i> Quick Tips
                </h4>
                <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-muted); line-height: 1.5; font-size: 0.9rem;">
                    <li>Save your API key for automatic login next time</li>
                    <li>Use headphones for better recording quality</li>
                    <li>Name your courses clearly for easy organization</li>
                    <li>Export flashcards regularly for spaced repetition</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal-overlay hidden">
        <div style="text-align: center;">
            <div class="loading-spinner" style="width: 50px; height: 50px; border-width: 4px;"></div>
            <p style="margin-top: 1.2rem; font-size: 1rem; color: var(--text-main);" id="loadingText">
                Loading your sessions...
            </p>
        </div>
    </div>

<!-- GLOBAL SCRIPTS (Non-Module) to ensure availability -->
<script>
// --- BACKGROUND ANIMATION ---
function initBackgroundAnimation() {
    const bgAnimation = document.getElementById('bgAnimation');
    for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'bg-particle';
        particle.style.width = Math.random() * 100 + 50 + 'px';
        particle.style.height = particle.style.width;
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.background = `radial-gradient(circle, 
            rgba(${Math.random() * 100 + 155}, ${Math.random() * 100 + 155}, 255, 0.1),
            transparent 70%)`;
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = Math.random() * 30 + 30 + 's';
        bgAnimation.appendChild(particle);
    }
}

// --- APP DETECTION LOGIC (APK HIDE/SHOW) ---
// Determine if we are running in an app wrapper or regular browser
const isRunningInApp = () => {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    // 1. Check for standard Android WebView indicator 'wv'
    if (/android/i.test(userAgent) && /wv/i.test(userAgent)) return true;
    // 2. Check for iOS standalone mode (Added to Home Screen)
    if (window.navigator.standalone === true) return true;
    // 3. Check for modern PWA standalone mode
    if (window.matchMedia('(display-mode: standalone)').matches) return true;
    // 4. Check for custom 'app' parameter in URL (e.g. ?app=true)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('app')) return true;
    
    return false;
};

function adjustButtonsForApp() {
    if (isRunningInApp()) {
        const btnFullscreen = document.getElementById('btnFullscreen');
        if (btnFullscreen) btnFullscreen.classList.add('hidden');
        
        const btnDownloadApp = document.getElementById('btnDownloadApp');
        if (btnDownloadApp) btnDownloadApp.classList.add('hidden');
    }
}

// --- TEXT TO SPEECH LOGIC (Enhanced) ---
function speakText(elementId) {
    if (!('speechSynthesis' in window)) {
        showToast("Text-to-speech not supported in this browser", "error");
        return;
    }

    const el = document.getElementById(elementId);
    if (!el || el.textContent.length < 5) {
        showToast("No text available to speak", "warning");
        return;
    }

    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(el.textContent);
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;

    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(v => v.name.includes("English") && v.lang.includes("en"));
    if (preferred) utterance.voice = preferred;

    const btn = document.activeElement;
    let originalText = "";
    if (btn && btn.tagName === "BUTTON") {
        originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-volume-up fa-spin"></i> Speaking...';
        btn.disabled = true;
    }

    utterance.onstart = () => {
        showToast("Starting text-to-speech playback", "info");
    };

    utterance.onend = () => {
        if (btn && btn.tagName === "BUTTON") {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        showToast("Text-to-speech finished", "success");
    };

    utterance.onerror = (e) => {
        console.error("Speech Error:", e);
        if (btn && btn.tagName === "BUTTON") {
            btn.innerHTML = '<i class="fas fa-times"></i> Error';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        }
        showToast("Audio playback failed", "error");
    };

    window.speechSynthesis.speak(utterance);
}

function stopSpeech() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        showToast("Speech stopped", "info");
    }
}

// --- TOAST NOTIFICATION SYSTEM ---
function showToast(message, type = "info") {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// --- LATEX TO UNICODE CONVERSION ---
function convertLatexToUnicode(text) {
    if (!text) return text;
    
    const latexMap = {
        // Greek letters
        '\\alpha': 'Î±', '\\beta': 'Î²', '\\gamma': 'Î³', '\\Gamma': 'Î“',
        '\\delta': 'Î´', '\\Delta': 'Î”', '\\epsilon': 'Îµ', '\\varepsilon': 'Îµ',
        '\\zeta': 'Î¶', '\\eta': 'Î·', '\\theta': 'Î¸', '\\Theta': 'Î˜',
        '\\iota': 'Î¹', '\\kappa': 'Îº', '\\lambda': 'Î»', '\\Lambda': 'Î›',
        '\\mu': 'Î¼', '\\nu': 'Î½', '\\xi': 'Î¾', '\\Xi': 'Îž',
        '\\pi': 'Ï€', '\\Pi': 'Î ', '\\rho': 'Ï', '\\sigma': 'Ïƒ', '\\Sigma': 'Î£',
        '\\tau': 'Ï„', '\\upsilon': 'Ï…', '\\phi': 'Ï†', '\\Phi': 'Î¦',
        '\\chi': 'Ï‡', '\\psi': 'Ïˆ', '\\Psi': 'Î¨', '\\omega': 'Ï‰', '\\Omega': 'Î©',
        
        // Mathematical operators
        '\\sum': 'âˆ‘', '\\prod': 'âˆ', '\\int': 'âˆ«', '\\oint': 'âˆ®',
        '\\partial': 'âˆ‚', '\\nabla': 'âˆ‡', '\\infty': 'âˆž',
        
        // Set theory
        '\\cup': 'âˆª', '\\cap': 'âˆ©', '\\subset': 'âŠ‚', '\\subseteq': 'âŠ†',
        '\\supset': 'âŠƒ', '\\supseteq': 'âŠ‡', '\\in': 'âˆˆ', '\\notin': 'âˆ‰',
        '\\emptyset': 'âˆ…', '\\varnothing': 'âˆ…',
        
        // Logic
        '\\wedge': 'âˆ§', '\\vee': 'âˆ¨', '\\neg': 'Â¬', '\\forall': 'âˆ€',
        '\\exists': 'âˆƒ', '\\nexists': 'âˆ„',
        
        // Relations
        '\\leq': 'â‰¤', '\\geq': 'â‰¥', '\\neq': 'â‰ ', '\\approx': 'â‰ˆ',
        '\\sim': 'âˆ¼', '\\simeq': 'â‰ƒ', '\\cong': 'â‰…', '\\equiv': 'â‰¡',
        '\\propto': 'âˆ',
        
        // Arrows
        '\\rightarrow': 'â†’', '\\leftarrow': 'â†', '\\Rightarrow': 'â‡’',
        '\\Leftarrow': 'â‡', '\\leftrightarrow': 'â†”', '\\Leftrightarrow': 'â‡”',
        
        // Other symbols
        '\\times': 'Ã—', '\\div': 'Ã·', '\\pm': 'Â±', '\\mp': 'âˆ“',
        '\\cdot': 'Â·', '\\circ': 'âˆ˜', '\\bullet': 'â€¢', '\\ast': 'âˆ—',
        '\\sqrt': 'âˆš', '\\angle': 'âˆ ', '\\triangle': 'â–³', '\\perp': 'âŠ¥',
        '\\parallel': 'âˆ¥', '\\ldots': 'â€¦', '\\cdots': 'â‹¯',
        '\\vdots': 'â‹®', '\\ddots': 'â‹±'
    };
    
    let result = text;
    
    // First, replace common LaTeX commands with Unicode
    for (const [latex, unicode] of Object.entries(latexMap)) {
        const regex = new RegExp(latex.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        result = result.replace(regex, unicode);
    }
    
    // Handle simple inline math: $...$ or $$...$$
    result = result.replace(/\$\$([^$]+)\$\$/g, '$1');
    result = result.replace(/\$([^$]+)\$/g, '$1');
    
    // Handle superscripts: ^{...} or ^x
    result = result.replace(/\^{(\w+)}/g, (match, p1) => {
        const superscripts = {'0': 'â°', '1': 'Â¹', '2': 'Â²', '3': 'Â³', '4': 'â´', 
                             '5': 'âµ', '6': 'â¶', '7': 'â·', '8': 'â¸', '9': 'â¹',
                             '+': 'âº', '-': 'â»', '=': 'â¼', '(': 'â½', ')': 'â¾',
                             'n': 'â¿', 'i': 'â±'};
        return p1.split('').map(c => superscripts[c] || c).join('');
    });
    
    // Handle subscripts: _{...} or _x
    result = result.replace(/_{(\w+)}/g, (match, p1) => {
        const subscripts = {'0': 'â‚€', '1': 'â‚', '2': 'â‚‚', '3': 'â‚ƒ', '4': 'â‚„',
                           '5': 'â‚…', '6': 'â‚†', '7': 'â‚‡', '8': 'â‚ˆ', '9': 'â‚‰',
                           '+': 'â‚Š', '-': 'â‚‹', '=': 'â‚Œ', '(': 'â‚', ')': 'â‚Ž',
                           'a': 'â‚', 'e': 'â‚‘', 'h': 'â‚•', 'i': 'áµ¢', 'k': 'â‚–',
                           'l': 'â‚—', 'm': 'â‚˜', 'n': 'â‚™', 'o': 'â‚’', 'p': 'â‚š',
                           'r': 'áµ£', 's': 'â‚›', 't': 'â‚œ', 'u': 'áµ¤', 'v': 'áµ¥',
                           'x': 'â‚“'};
        return p1.split('').map(c => subscripts[c] || c).join('');
    });
    
    // Handle fractions: \frac{a}{b}
    result = result.replace(/\\frac{([^}]+)}{([^}]+)}/g, '$1/$2');
    
    return result;
}

// --- ENHANCED MARKDOWN PARSER WITH MATH SUPPORT ---
function parseMarkdownWithMath(markdown) {
    if (!markdown) return '';
    
    // Convert LaTeX to Unicode first
    const processedMarkdown = convertLatexToUnicode(markdown);
    
    // Simple markdown parser for headings, bold, italic, lists
    let html = processedMarkdown
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        .replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
    
    // Wrap lists
    html = html.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
    
    // Convert line breaks to paragraphs
    const lines = html.split('\n');
    let inList = false;
    let result = '';
    
    for (const line of lines) {
        if (line.startsWith('<ul>') || line.startsWith('<li>') || line.startsWith('</ul>')) {
            result += line + '\n';
            inList = line.startsWith('<ul>') || line.startsWith('<li>');
        } else if (line.trim() === '') {
            if (!inList) result += '<br>\n';
        } else if (!line.startsWith('<h') && !line.startsWith('<ul') && !line.startsWith('</ul')) {
            result += '<p>' + line + '</p>\n';
        } else {
            result += line + '\n';
        }
    }
    
    return result;
}

// --- SESSION HISTORY MANAGER ---
class SessionHistory {
    constructor() {
        this.dbName = 'LectureScribeProSessions';
        this.storeName = 'sessions';
        this.version = 1; // Increment if schema changes
        this.db = null;
        this.initDB();
    }

    async initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    const store = db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                    store.createIndex('course', 'course', { unique: false });
                    store.createIndex('version', 'version', { unique: false });
                }
            };
            request.onsuccess = (e) => {
                this.db = e.target.result;
                resolve(this.db);
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async saveSession(sessionData) {
        if (!this.db) await this.initDB();
        
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            const store = tx.objectStore(this.storeName);
            
            sessionData.timestamp = Date.now();
            sessionData.lastAccessed = Date.now();
            sessionData.version = '2.1.0'; // Mark with current version
            
            const request = store.add(sessionData);
            request.onsuccess = () => {
                resolve(request.result);
                showToast("Session saved successfully!", "success");
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async getAllSessions() {
        if (!this.db) await this.initDB();
        
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readonly');
            const store = tx.objectStore(this.storeName);
            const index = store.index('timestamp');
            const request = index.getAll();
            
            request.onsuccess = () => {
                const sessions = request.result.sort((a, b) => b.timestamp - a.timestamp);
                resolve(sessions);
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async getSession(id) {
        if (!this.db) await this.initDB();
        
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readonly');
            const store = tx.objectStore(this.storeName);
            const request = store.get(parseInt(id));
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async deleteSession(id) {
        if (!this.db) await this.initDB();
        
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            const store = tx.objectStore(this.storeName);
            const request = store.delete(parseInt(id));
            
            request.onsuccess = () => {
                resolve();
                showToast("Session deleted", "success");
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async clearAllSessions() {
        if (!this.db) await this.initDB();
        
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            const store = tx.objectStore(this.storeName);
            const request = store.clear();
            
            request.onsuccess = () => {
                resolve();
                showToast("All sessions cleared", "success");
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async updateSessionAccess(id) {
        if (!this.db) await this.initDB();
        
        const session = await this.getSession(id);
        if (session) {
            session.lastAccessed = Date.now();
            
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(this.storeName, 'readwrite');
                const store = tx.objectStore(this.storeName);
                const request = store.put(session);
                
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }
    }
}

// Initialize session history manager
const sessionHistory = new SessionHistory();

// --- ENHANCED UI FUNCTIONS ---
function updateProgressBar(progressId, percentage) {
    const progressBar = document.getElementById(progressId);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
    }
}

function formatDate(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: diffDays < 365 ? undefined : 'numeric'
    });
}

async function loadSessionHistory() {
    const sessionList = document.getElementById('sessionList');
    const emptyHistory = document.getElementById('emptyHistory');
    
    sessionList.innerHTML = '';
    
    try {
        const sessions = await sessionHistory.getAllSessions();
        
        if (sessions.length === 0) {
            emptyHistory.classList.remove('hidden');
            return;
        }
        
        emptyHistory.classList.add('hidden');
        
        sessions.forEach(session => {
            const sessionItem = document.createElement('div');
            sessionItem.className = 'session-item';
            sessionItem.dataset.id = session.id;
            
            sessionItem.innerHTML = `
                <div class="session-course">${session.course || 'Unnamed Lecture'}</div>
                <div class="session-date">
                    <i class="far fa-calendar"></i>
                    ${formatDate(session.timestamp)}
                    ${session.flashcards ? `<span style="margin-left: 8px;"><i class="fas fa-layer-group"></i> ${session.flashcards.length} cards</span>` : ''}
                </div>
                <div class="session-actions">
                    <button class="session-action-btn delete-session" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            sessionItem.addEventListener('click', async (e) => {
                if (!e.target.closest('.session-action-btn')) {
                    await loadSession(session.id);
                }
            });
            
            sessionList.appendChild(sessionItem);
        });
        
        // Add delete event listeners
        document.querySelectorAll('.delete-session').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const sessionId = btn.closest('.session-item').dataset.id;
                if (confirm('Delete this session?')) {
                    await sessionHistory.deleteSession(sessionId);
                    loadSessionHistory();
                }
            });
        });
        
    } catch (error) {
        console.error('Error loading session history:', error);
        emptyHistory.classList.remove('hidden');
        emptyHistory.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <p>Error loading sessions</p>
        `;
    }
}

async function loadSession(sessionId) {
    try {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingText').textContent = 'Loading session...';
        
        const session = await sessionHistory.getSession(sessionId);
        
        if (!session) {
            showToast('Session not found', 'error');
            return;
        }
        
        // Update session access time
        await sessionHistory.updateSessionAccess(sessionId);
        
        // Load data into UI
        if (session.course) {
            document.getElementById('courseName').value = session.course;
        }
        
        if (session.study) {
            const processedStudy = parseMarkdownWithMath(session.study);
            document.getElementById('outputStudy').innerHTML = processedStudy;
            document.getElementById('btnDlStudy').disabled = false;
            rawStudyMarkdown = session.rawStudy || '';
        }
        
        if (session.scribe) {
            const processedScribe = parseMarkdownWithMath(session.scribe);
            document.getElementById('outputScribe').innerHTML = processedScribe;
            document.getElementById('btnDlScribe').disabled = false;
            rawScribeMarkdown = session.rawScribe || '';
        }
        
        if (session.flashcards) {
            flashcardsData = session.flashcards.map(card => ({
                front: convertLatexToUnicode(card.front),
                back: convertLatexToUnicode(card.back)
            }));
            renderCard(0);
            document.getElementById('btnDlCards').disabled = false;
            document.getElementById('cardsBadge').textContent = `${flashcardsData.length} cards`;
        }
        
        // Update badges
        document.getElementById('studyBadge').textContent = session.study ? 'âœ“ Ready' : 'Empty';
        document.getElementById('scribeBadge').textContent = session.scribe ? 'âœ“ Ready' : 'Empty';
        
        // Switch to result view
        switchView('result');
        setActiveTab('Study');
        
        // Close sidebar
        document.getElementById('historySidebar').classList.remove('active');
        
        showToast(`Loaded "${session.course || 'session'}"`, 'success');
        
    } catch (error) {
        console.error('Error loading session:', error);
        showToast('Failed to load session', 'error');
    } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }
}

async function saveCurrentSession() {
    const course = document.getElementById('courseName').value || 'Unnamed Lecture';
    const studyHTML = document.getElementById('outputStudy').innerHTML;
    const scribeHTML = document.getElementById('outputScribe').innerHTML;
    
    if (!studyHTML.includes('skeleton') && !scribeHTML.includes('skeleton') && flashcardsData.length > 0) {
        const sessionData = {
            course: course,
            timestamp: Date.now(),
            study: studyHTML,
            scribe: scribeHTML,
            flashcards: flashcardsData,
            rawStudy: rawStudyMarkdown,
            rawScribe: rawScribeMarkdown
        };
        
        try {
            await sessionHistory.saveSession(sessionData);
            await loadSessionHistory();
        } catch (error) {
            console.error('Error saving session:', error);
            showToast('Failed to save session', 'error');
        }
    } else {
        showToast('Please wait for all content to generate before saving', 'warning');
    }
}

// --- RESTORED AUTHENTICATION LOGIC ---
const REPO_OWNER = "Cleo876";
const REPO_NAME = "lsp-data";
const FILE_PATH = "lsp-data.json";

// --- OBFUSCATION ENGINE (1:1 from Dashboard) ---
const deobfuscate = (str) => {
    try {
        // Decode Base64 then unshift characters by -2
        const decoded = atob(str);
        return decoded.split('').map(c => String.fromCharCode(c.charCodeAt(0) - 2)).join('');
    } catch (e) { return "{}"; }
};

// --- LOGIN LOGIC (Safe-Parse) ---
document.addEventListener('DOMContentLoaded', () => {
    initBackgroundAnimation();
    
    const loginView = document.getElementById('login-view');
    const mainContainer = document.getElementById('mainContainer');
    const btnLogin = document.getElementById('btn-login');
    const loginEmail = document.getElementById('login-email');
    const loginUcode = document.getElementById('login-ucode');
    const loginStatus = document.getElementById('login-status');

    // Check if user is already authenticated (for development/testing)
    const isDevMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const bypassAuth = new URLSearchParams(window.location.search).has('dev');
    
    // --- SESSION PERSISTENCE LOGIC (3 Hour Timeout) ---
    const lastActive = localStorage.getItem('lsp_last_active');
    if (lastActive && !bypassAuth) {
        const diff = Date.now() - parseInt(lastActive, 10);
        if (diff < (3 * 60 * 60 * 1000)) { // 3 Hours
            // Valid Session: Refresh timestamp & bypass login
            localStorage.setItem('lsp_last_active', Date.now().toString()); 
            loginView.style.display = 'none';
            mainContainer.classList.remove('hidden');
            document.body.style.userSelect = "auto";
            // Adjust buttons for app
            adjustButtonsForApp();
            // Note: We don't return here so that event listeners below still attach correctly
        } else {
            // Session Expired
            localStorage.removeItem('lsp_last_active');
        }
    }
    
    if (isDevMode && bypassAuth) {
        loginView.style.display = 'none';
        mainContainer.classList.remove('hidden');
        document.body.style.userSelect = "auto";
        adjustButtonsForApp();
        return;
    }

    btnLogin.onclick = async () => {
        const emailInput = loginEmail.value.trim().toLowerCase();
        const codeInput = loginUcode.value.trim().toUpperCase();
        
        if (!emailInput || !codeInput) {
            loginStatus.innerText = "âœ— Please enter email and U-CODE";
            loginStatus.style.color = "var(--danger)";
            return;
        }
        
        loginStatus.innerText = "Connecting to network...";
        loginStatus.style.color = "var(--text-muted)";
        btnLogin.disabled = true;

        try {
            // MODIFIED: Use Raw GitHub Content (No Token Required)
            const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${FILE_PATH}`;
            const res = await fetch(url);
            
            if (!res.ok) throw new Error("Could not reach network database.");
            
            const content = await res.text();
            // Strip newlines just in case
            const sanitizedContent = content.replace(/\n/g, '');
            
            let db;
            try {
                db = JSON.parse(sanitizedContent);
            } catch (e) {
                try {
                    const jsonStr = deobfuscate(sanitizedContent); 
                    db = JSON.parse(jsonStr);
                } catch(err2) {
                    throw new Error("Registry decryption failed.");
                }
            }

            // Master Overwrite for Mr. Williams
            if (emailInput === "cleowillo@gmail.com" && codeInput === "K9W2") {
                loginSuccess(loginView, mainContainer, loginStatus, btnLogin);
                return;
            }

            // Universal Check (Distributors AND Customers)
            let authorized = false;
            if (db.distributors) {
                db.distributors.forEach(dist => {
                    // Check Distributor Creds
                    if (dist.email.toLowerCase() === emailInput && dist.u_code.toUpperCase() === codeInput) {
                        authorized = true;
                    }
                    // Check Customer Creds
                    if (dist.customers) {
                        dist.customers.forEach(cust => {
                            if (cust.email.toLowerCase() === emailInput && cust.u_code.toUpperCase() === codeInput) {
                                authorized = true;
                            }
                        });
                    }
                });
            }

            if (authorized) {
                loginSuccess(loginView, mainContainer, loginStatus, btnLogin);
            } else {
                loginStatus.innerText = "âœ— Invalid Credentials";
                loginStatus.style.color = "var(--danger)";
                btnLogin.disabled = false;
            }

        } catch (err) {
            console.error("Auth error:", err);
            loginStatus.innerText = "âœ— Network Error - Try Again";
            loginStatus.style.color = "var(--danger)";
            btnLogin.disabled = false;
            
            // Fallback for development
            if (isDevMode) {
                setTimeout(() => {
                    loginStatus.innerText = "âš ï¸ Using dev fallback...";
                    setTimeout(() => {
                        loginSuccess(loginView, mainContainer, loginStatus, btnLogin);
                    }, 1000);
                }, 1000);
            }
        }
    };

    // Allow Enter key to submit
    loginUcode.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') btnLogin.click();
    });
});

function loginSuccess(loginView, mainContainer, loginStatus, btnLogin) {
    localStorage.setItem('lsp_last_active', Date.now().toString()); // START SESSION TIMER
    loginStatus.innerText = "âœ“ Access Granted";
    loginStatus.style.color = "var(--success)";
    setTimeout(() => {
        loginView.style.display = 'none';
        mainContainer.classList.remove('hidden');
        document.body.style.userSelect = "auto";
        btnLogin.disabled = false;

        // Adjust buttons for app
        adjustButtonsForApp();

        // Load session history after successful login
        setTimeout(() => {
            loadSessionHistory();
        }, 500);
    }, 800);
}

// --- ENHANCED INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // These will be set up after login, but we define them here
    document.getElementById('btnOpenHistory')?.addEventListener('click', () => {
        document.getElementById('historySidebar').classList.add('active');
        loadSessionHistory();
    });
    
    document.getElementById('btnCloseHistory')?.addEventListener('click', () => {
        document.getElementById('historySidebar').classList.remove('active');
    });
    
    document.getElementById('btnClearHistory')?.addEventListener('click', async () => {
        if (confirm('Clear all session history? This cannot be undone.')) {
            await sessionHistory.clearAllSessions();
            loadSessionHistory();
        }
    });
    
    document.getElementById('btnLoadSession')?.addEventListener('click', () => {
        document.getElementById('historySidebar').classList.add('active');
        loadSessionHistory();
    });
    
    // Flashcard flip button
    document.getElementById('btnFlipCard')?.addEventListener('click', () => {
        document.getElementById('activeCard').classList.toggle('flipped');
    });
    
    // Enhanced save session function
    window.saveSession = saveCurrentSession;
    
    // Tutorial modal controls
    document.getElementById('btnWatchTutorial')?.addEventListener('click', () => {
        document.getElementById('tutorialModal')?.classList.remove('hidden');
    });
    
    document.getElementById('btnCloseTutorial')?.addEventListener('click', () => {
        document.getElementById('tutorialModal')?.classList.add('hidden');
    });
    
    // Help modal controls
    document.getElementById('btnOpenHelp')?.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('helpModal')?.classList.remove('hidden');
    });
    
    document.getElementById('btnCloseModal')?.addEventListener('click', () => {
        document.getElementById('helpModal')?.classList.add('hidden');
    });
});

// --- GLOBAL VARIABLES FOR ORIGINAL LOGIC ---
let rawStudyMarkdown = "";
let rawScribeMarkdown = "";
let flashcardsData = [];
let currentCardIndex = 0;

// --- ENHANCED SWITCH VIEW FUNCTION ---
function switchView(view) {
    ['step-setup','step-recording','step-processing','step-result'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });
    const targetEl = document.getElementById(`step-${view}`);
    if (targetEl) {
        targetEl.classList.remove('hidden');
    }
    
    if(view === 'result') {
        document.getElementById('mainContainer')?.classList.add('wide-mode');
        // Add subtle animation
        if (document.getElementById('mainContainer')) {
            document.getElementById('mainContainer').style.animation = 'slideUp 0.5s ease';
        }
    } else {
        document.getElementById('mainContainer')?.classList.remove('wide-mode');
    }
}

// --- ENHANCED RENDER CARD FUNCTION ---
function renderCard(index) {
    if (!flashcardsData || flashcardsData.length === 0) {
        const frontText = document.getElementById('cardFrontText');
        const backText = document.getElementById('cardBackText');
        const counter = document.getElementById('cardCounter');
        
        if (frontText) frontText.textContent = 'No flashcards available';
        if (backText) backText.textContent = '';
        if (counter) counter.textContent = '0 / 0';
        
        // Update progress bar
        const progressFill = document.getElementById('cardProgress');
        if (progressFill) progressFill.style.width = '0%';
        
        return;
    }
    
    currentCardIndex = index;
    const card = flashcardsData[index];
    
    const frontText = document.getElementById('cardFrontText');
    const backText = document.getElementById('cardBackText');
    const counter = document.getElementById('cardCounter');
    
    if (frontText) frontText.textContent = card.front;
    if (backText) backText.textContent = card.back;
    if (counter) counter.textContent = `${index + 1} / ${flashcardsData.length}`;
    
    const activeCard = document.getElementById('activeCard');
    if (activeCard) activeCard.classList.remove('flipped');
    
    const btnPrevCard = document.getElementById('btnPrevCard');
    const btnNextCard = document.getElementById('btnNextCard');
    if (btnPrevCard) btnPrevCard.disabled = index === 0;
    if (btnNextCard) btnNextCard.disabled = index === flashcardsData.length - 1;
    
    // Update progress bar
    const progressFill = document.getElementById('cardProgress');
    if (progressFill) {
        const progress = ((index + 1) / flashcardsData.length) * 100;
        progressFill.style.width = `${progress}%`;
    }
    
    // Update badge
    const cardsBadge = document.getElementById('cardsBadge');
    if (cardsBadge) cardsBadge.textContent = `${flashcardsData.length} cards`;
}

// Initialize card navigation
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnPrevCard')?.addEventListener('click', () => {
        if (currentCardIndex > 0) renderCard(currentCardIndex - 1);
    });
    
    document.getElementById('btnNextCard')?.addEventListener('click', () => {
        if (currentCardIndex < flashcardsData.length - 1) renderCard(currentCardIndex + 1);
    });
    
    document.getElementById('activeCard')?.addEventListener('click', () => {
        document.getElementById('activeCard')?.classList.toggle('flipped');
    });
});

// --- ORIGINAL DOWNLOAD FUNCTIONS (Placeholders - will be replaced by module) ---
window.downloadFlashcards = () => {
    if (!flashcardsData.length) {
        showToast("No flashcards generated.", "error");
        return;
    }
    
    let csvContent = "Front,Back\n";
    flashcardsData.forEach(card => {
        const f = `"${card.front.replace(/"/g, '""')}"`;
        const b = `"${card.back.replace(/"/g, '""')}"`;
        csvContent += `${f},${b}\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    const course = document.getElementById('courseName')?.value || "Class";
    link.download = `${course.replace(/\s+/g,'_')}_AnkiDeck.csv`;
    link.click();
    showToast("Flashcards downloaded successfully!", "success");
};

window.downloadRTF = (type) => {
    showToast("This function will be fully implemented in the module", "info");
    // This will be properly implemented in the module script
};

// --- SET ACTIVE TAB FUNCTION ---
function setActiveTab(tabName) {
    ['Study', 'Scribe', 'Cards'].forEach(t => {
        const btn = document.getElementById(`btnTab${t}`);
        const pane = document.getElementById(`pane${t}`);
        if (btn) btn.classList.remove('active');
        if (pane) pane.classList.remove('active');
    });
    
    const btn = document.getElementById(`btnTab${tabName}`);
    const pane = document.getElementById(`pane${tabName}`);
    if (btn) btn.classList.add('active');
    if (pane) pane.classList.add('active');
}

// Initialize tab switching
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnTabStudy')?.addEventListener('click', () => setActiveTab('Study'));
    document.getElementById('btnTabScribe')?.addEventListener('click', () => setActiveTab('Scribe'));
    document.getElementById('btnTabCards')?.addEventListener('click', () => setActiveTab('Cards'));
});

// Initialize mode tab switching
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('tabRecord')?.addEventListener('click', () => {
        document.getElementById('tabRecord').classList.add('active');
        document.getElementById('tabUpload').classList.remove('active');
        document.getElementById('modeRecord').classList.remove('hidden');
        document.getElementById('modeUpload').classList.add('hidden');
    });
    
    document.getElementById('tabUpload')?.addEventListener('click', () => {
        document.getElementById('tabUpload').classList.add('active');
        document.getElementById('tabRecord').classList.remove('active');
        document.getElementById('modeUpload').classList.remove('hidden');
        document.getElementById('modeRecord').classList.add('hidden');
    });
});
</script>

<script type="module">
// --- ORIGINAL MODULE CODE (Preserved with enhancements) ---
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
import { marked } from "https://esm.run/marked";

let wakeLock = null;
let detectedMimeType = ""; 
let mediaRecorder;
let startTime;
let timerInterval;
let currentBlob = null;
let debounceTimer; 
let elapsedMs = 0; 
let totalSize = 0;

class AudioDB {
    constructor(dbName = 'LectureScribePro', storeName = 'audioChunks') {
        this.dbName = dbName;
        this.storeName = storeName;
        this.db = null;
    }
    
    async open() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName, { autoIncrement: true });
                }
            };
            request.onsuccess = (e) => { 
                this.db = e.target.result; 
                resolve(this.db); 
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }
    
    async addChunk(chunk) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            tx.objectStore(this.storeName).add(chunk);
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e.target.error);
        });
    }
    
    async getAllChunks() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readonly');
            const request = tx.objectStore(this.storeName).getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }
    
    async clear() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            tx.objectStore(this.storeName).clear();
            tx.oncomplete = () => resolve();
        });
    }
}

const audioDB = new AudioDB();

// Element references
const els = {
    mainContainer: document.getElementById('mainContainer'),
    apiKey: document.getElementById('apiKey'),
    courseName: document.getElementById('courseName'),
    modelSelect: document.getElementById('modelSelect'),
    micQuality: document.getElementById('micQuality'),
    micSelect: document.getElementById('micSelect'),
    btnRefreshMics: document.getElementById('btnRefreshMics'),
    quotaInfo: document.getElementById('quotaInfo'),
    timer: document.getElementById('timer'),
    sizeMonitor: document.getElementById('sizeMonitor'),
    status: document.getElementById('processStatus'),
    subStatus: document.getElementById('processSubStatus'),
    
    outputStudy: document.getElementById('outputStudy'),
    outputScribe: document.getElementById('outputScribe'),
    flashcardContainer: document.getElementById('flashcardContainer'),
    
    spinStudy: document.getElementById('spinStudy'),
    spinScribe: document.getElementById('spinScribe'),
    spinCards: document.getElementById('spinCards'),
    
    btnDlStudy: document.getElementById('btnDlStudy'),
    btnDlScribe: document.getElementById('btnDlScribe'),
    btnDlCards: document.getElementById('btnDlCards'),

    modelLoadStatus: document.getElementById('modelLoadStatus'),
    quotaAlert: document.getElementById('quotaAlert'), 
    protocolAlert: document.getElementById('protocolAlert'),
    btnFullscreen: document.getElementById('btnFullscreen'),
    btnPause: document.getElementById('btnPause'),
    recordingStatus: document.getElementById('recordingStatus'),
    
    promptStudy: document.getElementById('promptStudy'),
    promptScribe: document.getElementById('promptScribe'),
    promptCards: document.getElementById('promptCards'),
    
    tabRecord: document.getElementById('tabRecord'),
    tabUpload: document.getElementById('tabUpload'),
    modeRecord: document.getElementById('modeRecord'),
    modeUpload: document.getElementById('modeUpload'),
    fileUpload: document.getElementById('fileUpload'),
    
    btnSelectFile: document.getElementById('btnSelectFile'),
    fileNameDisplay: document.getElementById('fileNameDisplay'),
    
    // Direct Review Elements
    btnDirectReview: document.getElementById('btnDirectReview'),
    directReviewInput: document.getElementById('directReviewInput'),

    btnTabStudy: document.getElementById('btnTabStudy'),
    btnTabScribe: document.getElementById('btnTabScribe'),
    btnTabCards: document.getElementById('btnTabCards'),
    paneStudy: document.getElementById('paneStudy'),
    paneScribe: document.getElementById('paneScribe'),
    paneCards: document.getElementById('paneCards'),
    
    activeCard: document.getElementById('activeCard'),
    cardFront: document.getElementById('cardFrontText'),
    cardBack: document.getElementById('cardBackText'),
    btnPrevCard: document.getElementById('btnPrevCard'),
    btnNextCard: document.getElementById('btnNextCard'),
    cardCounter: document.getElementById('cardCounter'),
    importCardsInput: document.getElementById('importCardsInput'),
    btnImportCards: document.getElementById('btnImportCards'),
    
    btnOpenHelp: document.getElementById('btnOpenHelp'),
    helpModal: document.getElementById('helpModal'),
    btnCloseModal: document.getElementById('btnCloseModal')
};

// Initialize after login
document.addEventListener('DOMContentLoaded', () => {
    // Wait a bit for the main container to be shown
    setTimeout(() => {
        if (els.mainContainer && !els.mainContainer.classList.contains('hidden')) {
            initializeApp();
        }
    }, 1000);
});

function initializeApp() {
    // CHECK PROTOCOL ON LOAD
    if (window.location.protocol === 'file:') {
        if (els.protocolAlert) {
            els.protocolAlert.style.display = 'block';
            els.protocolAlert.classList.remove('hidden');
        }
        const btnStart = document.getElementById('btnStart');
        if (btnStart) {
            btnStart.disabled = true;
            btnStart.innerText = "Blocked (HTTPS Required)";
            btnStart.style.background = "#334155";
        }
    }

    // AUTO-LOAD SAVED KEY
    const savedKey = localStorage.getItem('lsp_gemini_key');
    if (savedKey && els.apiKey) {
        els.apiKey.value = savedKey;
        if (savedKey.length > 20) loadModels(savedKey);
    }

    loadMicrophones();
    
    // Setup event listeners
    setupEventListeners();
}

async function loadMicrophones() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioDevices = devices.filter(d => d.kind === 'audioinput');
        if (els.micSelect) {
            els.micSelect.innerHTML = '<option value="">Default Microphone (System)</option>';
            audioDevices.forEach(device => {
                if (device.label) {
                    const opt = document.createElement('option');
                    opt.value = device.deviceId;
                    opt.text = device.label;
                    els.micSelect.appendChild(opt);
                }
            });
        }
    } catch(e) { 
        console.log("Error enumerating devices:", e); 
    }
}

function setupEventListeners() {
    // Microphone refresh
    if (els.btnRefreshMics) {
        els.btnRefreshMics.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(t => t.stop());
                await loadMicrophones();
            } catch (e) { 
                showToast("Could not access microphones. Please check browser permissions.", "error"); 
            }
        };
    }

    // FIXED: Fullscreen button - now fullscreens the entire page
    if (els.btnFullscreen) {
        els.btnFullscreen.onclick = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => { 
                    console.error(`Error: ${err.message}`); 
                });
            } else { 
                document.exitFullscreen(); 
            }
        };

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                els.btnFullscreen.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                els.btnFullscreen.innerHTML = '<i class="fas fa-expand"></i>';
            }
        });
    }

    // API Key input
    if (els.apiKey) {
        els.apiKey.addEventListener('input', (e) => {
            const key = e.target.value.trim();
            localStorage.setItem('lsp_gemini_key', key);
            clearTimeout(debounceTimer);
            if (key.length > 20) { 
                if (els.modelLoadStatus) {
                    els.modelLoadStatus.textContent = "Checking key...";
                    els.modelLoadStatus.style.color = "var(--text-muted)";
                }
                debounceTimer = setTimeout(() => { loadModels(key); }, 800); 
            } else { 
                if (els.modelLoadStatus) els.modelLoadStatus.textContent = ""; 
            }
        });
    }

    // Model select change
    if (els.modelSelect) {
        els.modelSelect.addEventListener('change', updateQuotaDisplay);
    }

    // File upload
    if (els.btnSelectFile && els.fileUpload) {
        els.btnSelectFile.onclick = () => { els.fileUpload.click(); };
    }
    
    if (els.fileUpload) {
        els.fileUpload.onchange = () => {
            const file = els.fileUpload.files[0];
            if (file && els.fileNameDisplay) {
                els.fileNameDisplay.textContent = "Selected: " + file.name;
                els.fileNameDisplay.style.color = "var(--success)";
                els.fileNameDisplay.style.fontWeight = "bold";
            } else if (els.fileNameDisplay) {
                els.fileNameDisplay.innerHTML = '<i class="fas fa-music"></i> No file selected';
            }
        };
    }

    // Mode tabs (already handled in global script, but keep for module compatibility)
    if (els.tabRecord && els.tabUpload) {
        els.tabRecord.onclick = () => {
            els.tabRecord.classList.add('active'); 
            els.tabUpload.classList.remove('active');
            if (els.modeRecord) els.modeRecord.classList.remove('hidden'); 
            if (els.modeUpload) els.modeUpload.classList.add('hidden');
        };
        
        els.tabUpload.onclick = () => {
            els.tabUpload.classList.add('active'); 
            els.tabRecord.classList.remove('active');
            if (els.modeUpload) els.modeUpload.classList.remove('hidden'); 
            if (els.modeRecord) els.modeRecord.classList.add('hidden');
        };
    }

    // Direct review
    if (els.btnDirectReview && els.directReviewInput) {
        els.btnDirectReview.onclick = () => { els.directReviewInput.click(); };
        els.directReviewInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                if(parseAndLoadCards(evt.target.result)) {
                    switchView('result');
                    setActiveTab('Cards');
                    if (els.btnTabStudy) els.btnTabStudy.style.display = 'none';
                    if (els.btnTabScribe) els.btnTabScribe.style.display = 'none';
                    if (els.outputStudy) {
                        els.outputStudy.innerHTML = "<p style='color:#64748b; text-align:center;'>Review Mode Only (Study Guide not loaded)</p>";
                    }
                    if (els.outputScribe) {
                        els.outputScribe.innerHTML = "<p style='color:#64748b; text-align:center;'>Review Mode Only (Scribe Notes not loaded)</p>";
                    }
                    if (els.btnDlCards) els.btnDlCards.disabled = false;
                }
            };
            reader.readAsText(file);
        };
    }

    // Import cards
    if (els.btnImportCards && els.importCardsInput) {
        els.btnImportCards.onclick = () => { els.importCardsInput.click(); };
        els.importCardsInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                if(parseAndLoadCards(evt.target.result)) {
                    showToast(`Imported ${flashcardsData.length} cards successfully!`, "success");
                }
            };
            reader.readAsText(file);
            els.importCardsInput.value = '';
        };
    }

    // Start recording
    const btnStart = document.getElementById('btnStart');
    if (btnStart) {
        btnStart.onclick = startRecording;
    }

    // Pause/Resume recording
    if (els.btnPause) {
        els.btnPause.onclick = togglePauseRecording;
    }

    // Stop recording
    const btnStop = document.getElementById('btnStop');
    if (btnStop) {
        btnStop.onclick = stopRecording;
    }

    // Upload process
    const btnUploadProcess = document.getElementById('btnUploadProcess');
    if (btnUploadProcess) {
        btnUploadProcess.onclick = processUploadedFile;
    }
}

async function loadModels(key) {
    try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
        if (resp.status === 400 || resp.status === 403) throw new Error("Invalid API Key");
        const data = await resp.json();
        const models = (data.models || []).filter(m => m.supportedGenerationMethods?.includes("generateContent"))
            .map(m => m.name.replace('models/', '')).sort();
        
        if (els.modelSelect) {
            els.modelSelect.innerHTML = "";
            models.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m; 
                opt.textContent = m;
                if(m.includes("flash") && !m.includes("8b")) opt.selected = true;
                els.modelSelect.appendChild(opt);
            });
        }
        
        if (els.modelLoadStatus) {
            els.modelLoadStatus.textContent = "âœ“ Key Valid & Models Loaded"; 
            els.modelLoadStatus.style.color = "var(--success)";
        }
        updateQuotaDisplay();
    } catch (e) {
        if (els.modelLoadStatus) {
            els.modelLoadStatus.textContent = "âœ— Error: " + e.message;
            els.modelLoadStatus.style.color = "var(--danger)";
        }
    }
}

function updateQuotaDisplay() {
    if (!els.modelSelect || !els.quotaInfo) return;
    
    const model = els.modelSelect.value;
    if (model.includes("flash")) {
        els.quotaInfo.innerHTML = `Google API Quota: <span>~500 recordings/day</span> (1500 req/day).<br>Speed Limit: <span>5 recordings/minute</span> (15 req/min).`;
    } else if (model.includes("pro")) {
         els.quotaInfo.innerHTML = `Google API Quota: <span>~16 recordings/day</span> (50 req/day).<br>Speed Limit: <span>~1 recording/minute</span> (2 req/min).`;
    }
}

function parseAndLoadCards(text) {
    try {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        const newCards = [];
        const startIndex = (lines[0].toLowerCase().includes("front") && lines[0].toLowerCase().includes("back")) ? 1 : 0;
        
        for(let i = startIndex; i < lines.length; i++) {
            const line = lines[i];
            const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || line.split(',');
            if (matches && matches.length >= 2) {
                let front = matches[0].replace(/^"|"$/g, '').replace(/""/g, '"').trim();
                const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                if (parts.length >= 2) {
                    front = parts[0].replace(/^"|"$/g, '').replace(/""/g, '"').trim();
                    let back = parts[1].replace(/^"|"$/g, '').replace(/""/g, '"').trim();
                    newCards.push({ 
                        front: convertLatexToUnicode(front),
                        back: convertLatexToUnicode(back)
                    });
                }
            }
        }
        
        if (newCards.length > 0) {
            flashcardsData = newCards;
            renderCard(0);
            return true;
        } else {
            showToast("Could not find valid flashcards in this CSV.", "error");
            return false;
        }
    } catch(err) {
        showToast("Error parsing CSV: " + err.message, "error");
        return false;
    }
}

async function startRecording() {
    if (!els.apiKey.value) {
        showToast("Please enter your API Key.", "error");
        return;
    }
    
    try {
        try { 
            wakeLock = await navigator.wakeLock.request('screen'); 
        } catch (e) {
            console.log("Wake lock not supported:", e);
        }
        
        await audioDB.open(); 
        await audioDB.clear();
        
        const selectedMicId = els.micSelect.value;
        const constraints = {
            audio: { 
                echoCancellation: true, 
                deviceId: selectedMicId ? { exact: selectedMicId } : undefined 
            }
        };
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        const quality = parseInt(els.micQuality.value);
        let options = { bitsPerSecond: quality };
        
        if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            detectedMimeType = 'audio/webm;codecs=opus';
        } else if (MediaRecorder.isTypeSupported('audio/webm')) {
            detectedMimeType = 'audio/webm';
        } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
            detectedMimeType = 'audio/mp4'; 
        } else {
            detectedMimeType = '';
        }
        
        if (detectedMimeType) options.mimeType = detectedMimeType;
        
        mediaRecorder = new MediaRecorder(stream, options);
        totalSize = 0; 
        elapsedMs = 0;
        
        mediaRecorder.ondataavailable = async (e) => {
            if (e.data.size > 0) {
                await audioDB.addChunk(e.data);
                totalSize += e.data.size;
                updateSizeDisplay(totalSize);
                if (totalSize > 99.5 * 1024 * 1024) {
                    mediaRecorder.stop();
                }
            }
        };
        
        mediaRecorder.start(1000);
        startTimer();
        switchView('recording');
        
    } catch (e) { 
        if (e.name === "NotAllowedError" || e.name === "PermissionDeniedError") {
            showToast("Microphone Access Denied. If using file://, upload to HTTPS website.", "error");
        } else { 
            showToast("Recording Error: " + e.message, "error");
        }
    }
}

function togglePauseRecording() {
    if (!mediaRecorder) return;
    
    if (mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
        clearInterval(timerInterval);
        if (els.btnPause) {
            els.btnPause.innerHTML = '<i class="fas fa-play"></i> Resume';
            els.btnPause.classList.replace('btn-warning', 'btn-primary');
        }
        if (els.recordingStatus) {
            els.recordingStatus.textContent = "â¸ PAUSED";
            els.recordingStatus.style.animation = "none";
        }
    } else if (mediaRecorder.state === 'paused') {
        mediaRecorder.resume();
        startTimer();
        if (els.btnPause) {
            els.btnPause.innerHTML = '<i class="fas fa-pause"></i> Pause';
            els.btnPause.classList.replace('btn-primary', 'btn-warning');
        }
        if (els.recordingStatus) {
            els.recordingStatus.textContent = "â— RECORDING LIVE";
            els.recordingStatus.style.animation = "pulse 2s infinite";
        }
    }
}

async function stopRecording() {
    if(mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    
    if(mediaRecorder && mediaRecorder.stream) {
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
    
    clearInterval(timerInterval);
    
    if(wakeLock) {
        wakeLock.release();
        wakeLock = null;
    }
    
    if (mediaRecorder) {
        mediaRecorder.onstop = async () => {
            const chunks = await audioDB.getAllChunks();
            const finalType = detectedMimeType || 'audio/webm';
            currentBlob = new Blob(chunks, { type: finalType });
            processMultiEngine();
        };
    }
}

async function processUploadedFile() {
    if (!els.apiKey.value) {
        showToast("Please enter your API Key.", "error");
        return;
    }
    
    if (!els.fileUpload.files[0]) {
        showToast("Please select an audio file.", "error");
        return;
    }
    
    currentBlob = els.fileUpload.files[0];
    processMultiEngine();
}

function startTimer() {
    startTime = Date.now() - elapsedMs;
    timerInterval = setInterval(() => {
        elapsedMs = Date.now() - startTime;
        if (els.timer) {
            els.timer.innerText = new Date(elapsedMs).toISOString().substr(11, 8);
        }
    }, 1000);
}

function updateSizeDisplay(bytes) {
    const mb = (bytes / (1024*1024)).toFixed(2);
    if (els.sizeMonitor) {
        els.sizeMonitor.innerHTML = `<i class="fas fa-hdd"></i> Current Size: <span id="sizeValue">${mb}</span> MB`;
    }
    
    // Update progress bar
    const progress = (bytes / (99.5 * 1024 * 1024)) * 100;
    updateProgressBar('sizeProgress', Math.min(progress, 100));
}

async function processMultiEngine() {
    if (els.quotaAlert) {
        els.quotaAlert.style.display = 'none';
        els.quotaAlert.classList.add('hidden');
    }
    
    // 1. Immediate UI Switch
    switchView('processing');
    if (els.status) els.status.innerText = "Encoding Audio...";
    
    const apiKey = els.apiKey.value;
    const genAI = new GoogleGenerativeAI(apiKey);
    const modelName = els.modelSelect.value;
    const model = genAI.getGenerativeModel({ model: modelName });
    const course = els.courseName.value || "General Class";
    
    // Base64 Encoding
    let base64Audio;
    try {
        base64Audio = await blobToBase64(currentBlob);
    } catch(e) { 
        showToast("Audio encoding failed", "error"); 
        return; 
    }
    
    // Switch to Results View IMMEDIATELY
    switchView('result');
    
    // Setup Loading States
    const loadingHTML = `
        <div class="skeleton" style="height: 18px; width: 40%; margin-bottom: 15px;"></div>
        <div class="skeleton" style="height: 14px; margin-bottom: 10px;"></div>
        <div class="skeleton" style="height: 14px; width: 80%; margin-bottom: 10px;"></div>
        <div class="skeleton" style="height: 14px; width: 60%; margin-bottom: 10px;"></div>
        <div class="skeleton" style="height: 14px; margin-bottom: 10px;"></div>
        <div class="skeleton" style="height: 14px; width: 80%; margin-bottom: 10px;"></div>
        <p style="text-align:center; color:#64748b; font-size:0.85rem; margin-top: 15px;">Analysing audio & generating notes...</p>
    `;
    
    if (els.outputStudy) els.outputStudy.innerHTML = loadingHTML;
    if (els.outputScribe) els.outputScribe.innerHTML = loadingHTML;
    if (els.flashcardContainer) els.flashcardContainer.style.opacity = "0.6"; 
    
    if (els.spinStudy) els.spinStudy.classList.remove('hidden');
    if (els.spinScribe) els.spinScribe.classList.remove('hidden');
    if (els.spinCards) els.spinCards.classList.remove('hidden');

    if (els.btnDlStudy) els.btnDlStudy.disabled = true;
    if (els.btnDlScribe) els.btnDlScribe.disabled = true;
    if (els.btnDlCards) els.btnDlCards.disabled = true;

    const finalMimeType = currentBlob.type || detectedMimeType || 'audio/webm';
    const payload = { inlineData: { mimeType: finalMimeType, data: base64Audio } };

    // Helper functions
    const runStudy = async () => {
        try {
            const res = await model.generateContent([
                payload, 
                els.promptStudy.value.replace("[COURSE_NAME]", course)
            ]);
            rawStudyMarkdown = await res.response.text();
            const processedStudy = convertLatexToUnicode(rawStudyMarkdown);
            
            if (els.outputStudy) {
                els.outputStudy.innerHTML = marked.parse(processedStudy);
            }
            
            if (els.spinStudy) els.spinStudy.classList.add('hidden');
            if (els.btnDlStudy) els.btnDlStudy.disabled = false;
            if (document.getElementById('studyBadge')) {
                document.getElementById('studyBadge').textContent = 'âœ“ Ready';
            }
            
            // Save session after study guide is ready
            setTimeout(saveCurrentSession, 500);
            
        } catch(e) { 
            if (els.outputStudy) {
                els.outputStudy.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`; 
            }
            if (els.spinStudy) els.spinStudy.classList.add('hidden');
            showToast("Study guide generation failed", "error");
        }
    };

    const runScribe = async () => {
        try {
            const res = await model.generateContent([
                payload, 
                els.promptScribe.value.replace("[COURSE_NAME]", course)
            ]);
            rawScribeMarkdown = await res.response.text();
            const processedScribe = convertLatexToUnicode(rawScribeMarkdown);
            
            if (els.outputScribe) {
                els.outputScribe.innerHTML = marked.parse(processedScribe);
            }
            
            if (els.spinScribe) els.spinScribe.classList.add('hidden');
            if (els.btnDlScribe) els.btnDlScribe.disabled = false;
            if (document.getElementById('scribeBadge')) {
                document.getElementById('scribeBadge').textContent = 'âœ“ Ready';
            }
            
        } catch(e) { 
            if (els.outputScribe) {
                els.outputScribe.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`; 
            }
            if (els.spinScribe) els.spinScribe.classList.add('hidden');
            showToast("Scribe notes generation failed", "error");
        }
    };

    const runCards = async () => {
        try {
            const res = await model.generateContent([
                payload, 
                els.promptCards.value.replace("[COURSE_NAME]", course)
            ]);
            const t3 = await res.response.text();
            
            try { 
                const parsedCards = JSON.parse(t3.replace(/```json/g, '').replace(/```/g, '').trim());
                flashcardsData = parsedCards.map(card => ({
                    front: convertLatexToUnicode(card.front),
                    back: convertLatexToUnicode(card.back)
                }));
                renderCard(0); 
            } catch (e) { 
                flashcardsData = [{front: "Error generating cards", back: "Raw: " + t3}]; 
                renderCard(0); 
            }
            
            if (els.flashcardContainer) els.flashcardContainer.style.opacity = "1";
            if (els.spinCards) els.spinCards.classList.add('hidden');
            if (els.btnDlCards) els.btnDlCards.disabled = false;
            if (document.getElementById('cardsBadge')) {
                document.getElementById('cardsBadge').textContent = `${flashcardsData.length} cards`;
            }
            
            showToast(`Generated ${flashcardsData.length} flashcards`, "success");
            
        } catch(e) { 
            flashcardsData = [{front: "Error", back: e.message}]; 
            renderCard(0);
            if (els.spinCards) els.spinCards.classList.add('hidden');
            showToast("Flashcard generation failed", "error");
        }
    };

    // Execution Logic: Parallel for Flash, Sequential for Pro
    try {
        if (modelName.includes("pro")) {
            // Sequential for safety
            await runStudy();
            await runScribe();
            await runCards();
        } else {
            // Parallel for speed
            await Promise.all([runStudy(), runScribe(), runCards()]);
        }
    } catch (error) {
        showToast("Processing failed: " + error.message, "error");
    }
}

function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const result = reader.result;
            if (typeof result === 'string') {
                resolve(result.split(',')[1]);
            } else {
                reject(new Error('Failed to read blob as base64'));
            }
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// Override the global downloadRTF function with proper implementation
window.downloadRTF = (type) => {
    const course = els.courseName?.value || "Class";
    const title = type === 'study' ? "Study_Guide" : "Scribe_Notes";
    const markdown = type === 'study' ? rawStudyMarkdown : rawScribeMarkdown;
    
    if(!markdown) {
        showToast("Content not ready yet.", "warning");
        return;
    }
    
    let rtfBody = markdownToRTF(convertLatexToUnicode(markdown));
    let rtf = `{\\rtf1\\ansi\\ansicpg1252\\deff0{\\fonttbl{\\f0 Arial;}}\\f0\\fs24 \n`;
    rtf += `{\\colortbl;\\red0\\green0\\blue0;\\red59\\green130\\blue246;}\n`; 
    rtf += `\\pard\\sa200\\sl276\\slmult1\\b\\fs36 ${course} - ${title.replace('_', ' ')}\\b0\\fs24 \\par \n`;
    rtf += `Generated: ${new Date().toLocaleString()} \\par \\par \n`;
    rtf += `-------------------------------------------------- \\par \\par \n`;
    rtf += rtfBody;
    rtf += `\n}`;
    
    const blob = new Blob([rtf], { type: "application/rtf" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${course.replace(/\s+/g,'_')}_${title}.rtf`;
    link.click();
    
    showToast(`${title} downloaded successfully!`, "success");
};

function markdownToRTF(md) {
    let lines = md.split('\n');
    let rtf = "";
    lines.forEach(line => {
        line = line.trim();
        if (!line) { rtf += "\\par \n"; return; }
        line = escapeUnicode(line);
        if (line.startsWith('# ')) { rtf += `\\par\\pard\\sa200\\sb200\\b\\fs32 ${line.substring(2)}\\b0\\fs24\\par \n`; return; }
        if (line.startsWith('## ')) { rtf += `\\par\\pard\\sa150\\sb150\\b\\fs28 ${line.substring(3)}\\b0\\fs24\\par \n`; return; }
        if (line.startsWith('### ')) { rtf += `\\par\\pard\\sa100\\sb100\\b\\i ${line.substring(4)}\\i0\\b0\\par \n`; return; }
        if (line.includes('|')) {
            let rowContent = line.replace(/^\||\|$/g, '');
            if (rowContent.includes('---')) return; 
            let cells = rowContent.split('|').map(c => c.trim());
            rtf += `\\pard\\tqr\\tx9000 ${cells.join('\\tab ')} \\par \n`;
            return;
        }
        line = line.replace(/\*\*(.*?)\*\*/g, '\\b $1\\b0 ');
        line = line.replace(/\*(.*?)\*/g, '\\i $1\\i0 ');
        if (line.startsWith('- ') || line.startsWith('* ')) {
            rtf += `\\par\\pard\\li720\\fi-360 \\bullet \\tab ${line.substring(2)} \\par \n`;
        } else if (/^\d+\./.test(line)) {
            rtf += `\\par\\pard\\li720\\fi-360 ${line.split('.')[0]}. \\tab ${line.substring(line.indexOf('.')+1).trim()} \\par \n`;
        } else {
            rtf += `\\pard\\sa100 ${line} \\par \n`;
        }
    });
    return rtf;
}

function escapeUnicode(str) {
    return str.replace(/[^\x00-\x7F]/g, char => {
        const code = char.charCodeAt(0);
        return `\\uc1\\u${code}?`;
    });
}

// Initialize the app when module loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    initializeApp();
}
</script>

<!-- Add Font Awesome for icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>
